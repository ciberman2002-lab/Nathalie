---
// src/pages/blog/[slug].astro
import '../../styles/global.css';
import Header from '../../components/Header';
import Footer from '../../components/Footer';
import WhatsAppButton from '../../components/WhatsAppButton';
import Article from '../../components/Article';

import { createReader } from '@keystatic/core/reader';
import keystaticConfig from '../../../keystatic.config';

// ðŸ”¹ IMPORTANTE: manter server-side para Keystatic + Vercel
export const prerender = true;

// ======================================================
// âœ… 1) GERAR TODAS AS ROTAS CORRETAMENTE (EVITA 404)
// ======================================================
export async function getStaticPaths() {
  const reader = createReader(process.cwd(), keystaticConfig);
  const allArtigos = await reader.collections.artigos.list();

  return allArtigos.map((slug) => ({
    params: { slug },
  }));
}

// ======================================================
// âœ… 2) LEITURA SEGURA DO ARTIGO (FUNCIONA NO VERCEL)
// ======================================================
const reader = createReader(process.cwd(), keystaticConfig);

const { slug } = Astro.params;

// ðŸ”¹ LÃª o artigo do Keystatic (se nÃ£o existir, cai no 404)
const entry = await reader.collections.artigos.read(slug);

if (!entry) {
  return Astro.redirect('/404');
}

// ðŸ”¹ Converte o conteÃºdo mdoc para AST (JSON que seu renderer entende)
const contentAst = entry.content ? await entry.content() : null;

if (!contentAst) {
  return Astro.redirect('/404');
}

// ======================================================
// âœ… 3) NORMALIZAÃ‡ÃƒO DO POST (MANTENDO SEUS CAMPOS)
// ======================================================
const post = {
  title: entry.title,
  category: entry.category,
  date: entry.date,
  author: entry.author,
  heroImage: entry.heroImage,
  quote: entry.quote,
  content: contentAst, // AST do Markdoc/Keystatic
  specialistNote: entry.specialistNote,
  tags: entry.tags,
  recommended: entry.recommended,
};
---

<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{post.title} | Dra. Nathalie Almeida</title>

    <meta
      name="description"
      content={post.quote ||
        'Artigo jurÃ­dico especializado pela Dra. Nathalie Almeida'}
    />

    <meta property="og:title" content={post.title} />
    <meta property="og:description" content={post.quote} />
    <meta property="og:image" content={post.heroImage?.src} />
    <meta property="og:type" content="article" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>

  <body
    class="bg-[#fdfbf7] selection:bg-[#4a0404] selection:text-white overflow-x-hidden"
  >
    <Header client:load />

    <main class="pt-32 pb-24 max-w-5xl mx-auto px-6 paddingTopMobile">
      <Article
        client:load
        title={post.title}
        category={post.category}
        date={post.date}
        author={post.author}
        heroImage={post.heroImage}
        quote={post.quote}
        content={post.content}
        specialistNote={post.specialistNote}
        tags={post.tags}
        recommended={post.recommended}
      />
    </main>

    <Footer client:load />
    <WhatsAppButton client:idle />
  </body>
</html>

